<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback - LeckerHaus</title>
    <link rel="stylesheet" href="css/base.css?v=2.0">
    <link rel="stylesheet" href="css/feedback.css?v=2.0">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <h1>LeckerHaus</h1>
            </div>
            <nav class="navigation">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="menu.html">Menu</a></li>
                    <li><a href="catering.html">Catering</a></li>
                    <li><a href="order-history.php">Order History</a></li>
                    <li><a href="feedback.html" class="active">Feedback</a></li>
                </ul>
            </nav>
            <div class="cart-section">
                <span class="user-greeting" style="display:none;">Hello, User!</span>
                <button class="logout-button" style="display:none;">Logout</button>
                <a href="login.html" class="login-button">
                    <span class="login-text">Login</span>
                </a>
                <a href="cart.html" class="cart-button">
                    <span class="cart-text">Cart</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Feedback Page -->
    <div class="feedback-page">
        <div class="page-header">
            <h1>We Value Your Feedback</h1>
            <p>Help us improve by sharing your experience</p>
        </div>

        <div class="content-container">
            <section class="feedback-form-section">
                <div id="formMessage" class="form-message" style="display:none;margin-bottom:16px;padding:12px;border-radius:4px;"></div>
                <h2>Share Your Experience</h2>
                <form id="feedbackForm" class="feedback-form" method="POST" action="backend/process-feedback.php" onsubmit="return validateFeedbackForm(this);">
                    <div class="form-group">
                        <label for="customer_name">Your Name *</label>
                        <input type="text" id="customer_name" name="customer_name" required>
                    </div>

                    <div class="form-group">
                        <label for="customer_email">Email *</label>
                        <input type="email" id="customer_email" name="customer_email" required>
                    </div>

                    <div class="form-group">
                        <label for="order_number">Order Number (Optional)</label>
                        <input type="text" id="order_number" name="order_number" placeholder="e.g., #12345">
                    </div>

                    <div class="form-group">
                        <label for="rating">Overall Rating *</label>
                        <div class="rating-input">
                            <select id="rating" name="rating" required>
                                <option value="">Select rating</option>
                                <option value="5">⭐⭐⭐⭐⭐ Excellent</option>
                                <option value="4">⭐⭐⭐⭐ Good</option>
                                <option value="3">⭐⭐⭐ Average</option>
                                <option value="2">⭐⭐ Below Average</option>
                                <option value="1">⭐ Poor</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="comment">Your Feedback *</label>
                        <textarea id="comment" name="comment" rows="6" placeholder="Tell us about your experience..." required></textarea>
                    </div>

                    <button type="submit" class="submit-button">Submit Feedback</button>
                </form>
            </section>

            <section class="testimonials-section">
                <h2>What Our Customers Say</h2>
                <div id="testimonialsContainer" class="testimonials-container">
                    <p class="loading-text">Loading testimonials...</p>
                </div>
            </section>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2024 LeckerHaus. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/auth.js"></script>
    <script src="js/validation.js"></script>
    <script>
        // Read message from query params and show above the form
        (function showMessageFromQuery() {
            try {
                const params = new URLSearchParams(window.location.search);
                if (!params) return;

                const msg = params.get('msg');
                const success = params.has('success');
                const error = params.has('error');
                if (!msg || (!success && !error)) {
                    // nothing to show
                    // clean URL if only msg absent
                    if (params.toString()) history.replaceState(null, '', window.location.pathname);
                    return;
                }

                const container = document.getElementById('formMessage');
                if (!container) return;

                // sanitize by using textContent
                container.textContent = msg;
                if (success) {
                    container.style.display = 'block';
                    container.style.backgroundColor = '#e6ffed';
                    container.style.border = '1px solid #29a745';
                    container.style.color = '#135e2a';
                } else {
                    container.style.display = 'block';
                    container.style.backgroundColor = '#fff3f2';
                    container.style.border = '1px solid #e5534b';
                    container.style.color = '#6b1b0f';
                }

                // remove query params so message doesn't reappear on refresh
                history.replaceState(null, '', window.location.pathname + window.location.hash);
            } catch (e) {
                console.error('Error showing form message:', e);
            }
        })();
    </script>
    <script>
        // Load approved testimonials
        async function loadTestimonials() {
            try {
                const response = await fetch('backend/api/get-testimonials.php');
                if (!response.ok) throw new Error('Failed to load testimonials');
                
                const testimonials = await response.json();
                renderTestimonials(testimonials);
            } catch (error) {
                document.getElementById('testimonialsContainer').innerHTML = 
                    '<p class="error-text">Unable to load testimonials at this time.</p>';
            }
        }

        function renderTestimonials(testimonials) {
            const container = document.getElementById('testimonialsContainer');
            
            if (testimonials.length === 0) {
                container.innerHTML = '<p>No testimonials yet. Be the first to share your feedback!</p>';
                return;
            }
            
            container.innerHTML = testimonials.map(testimonial => `
                <article class="testimonial-card">
                    <div class="testimonial-header">
                        <div class="testimonial-author">
                            <strong>${escapeHtml(testimonial.name)}</strong>
                            <span class="testimonial-date">${formatDate(testimonial.created_at)}</span>
                        </div>
                        <div class="testimonial-rating">
                            ${'⭐'.repeat(parseInt(testimonial.rating))}
                        </div>
                    </div>
                    <div class="testimonial-content">
                        <p>${escapeHtml(testimonial.feedback)}</p>
                        ${testimonial.order_number ? `<p class="testimonial-order">Order #${escapeHtml(testimonial.order_number)}</p>` : ''}
                    </div>
                </article>
            `).join('');
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load testimonials on page load
        loadTestimonials();

        // Pre-fill user info if logged in
        const user = sessionStorage.getItem('user');
        if (user) {
            try {
                const userData = JSON.parse(user);
                if (userData.username) {
                    document.getElementById('customer_name').value = userData.username;
                }
                if (userData.email) {
                    document.getElementById('customer_email').value = userData.email;
                }
            } catch (e) {
                console.error('Error parsing user data:', e);
            }
        }
    </script>
</body>
</html>
