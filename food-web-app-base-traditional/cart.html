<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - LeckerHaus</title>
    <link rel="stylesheet" href="css/base.css?v=2.0">
    <link rel="stylesheet" href="css/cart.css?v=2.0">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <h1>LeckerHaus</h1>
            </div>
            <nav class="navigation">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="menu.html">Menu</a></li>
                    <li><a href="catering.html">Catering</a></li>
                    <li><a href="order-history.php">Order History</a></li>
                    <li><a href="feedback.html">Feedback</a></li>
                </ul>
            </nav>
            <div class="cart-section">
                <span class="user-greeting" style="display:none;">Hello, User!</span>
                <button class="logout-button" style="display:none;">Logout</button>
                <a href="login.html" class="login-button">
                    <span class="login-text">Login</span>
                </a>
                <a href="cart.html" class="cart-button">
                    <span class="cart-text">Cart</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Cart Page -->
    <div class="cart-page">
        <div class="cart-header">
            <h1>Shopping Cart</h1>
            <p id="cartItemCount">0 items</p>
        </div>

        <div id="loadingState" class="loading-state" style="display: none;">
            <p>Loading cart...</p>
        </div>

        <div id="errorState" class="error-state" style="display: none;">
            <p id="errorText"></p>
        </div>

        <div id="emptyCart" class="empty-cart" style="display: none;">
            <p>Your cart is empty</p>
            <a href="menu.html" class="btn-primary">Browse Menu</a>
        </div>

        <div id="cartContent" class="cart-content" style="display: none;">
            <div class="cart-items-section">
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="cartItemsBody">
                        <!-- Cart items will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="checkout-section">
                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Delivery Fee:</span>
                        <span>$5.00</span>
                    </div>
                    <div class="summary-row total">
                        <strong>Total:</strong>
                        <strong id="total">$5.00</strong>
                    </div>
                </div>

                <form id="checkoutForm" class="checkout-form">
                    <h3>Delivery Information</h3>
                    
                    <div class="form-group">
                        <label for="customerName">Full Name *</label>
                        <input type="text" id="customerName" name="customer_name" required>
                    </div>

                    <div class="form-group">
                        <label for="customerEmail">Email *</label>
                        <input type="email" id="customerEmail" name="customer_email" required>
                    </div>

                    <div class="form-group">
                        <label for="customerPhone">Phone Number *</label>
                        <input type="tel" id="customerPhone" name="customer_phone" required>
                    </div>

                    <div class="form-group">
                        <label for="deliveryAddress">Delivery Address *</label>
                        <textarea id="deliveryAddress" name="delivery_address" rows="3" required></textarea>
                    </div>

                    <button type="submit" class="btn-primary" id="placeOrderBtn">
                        Place Order
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2024 LeckerHaus. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/auth.js"></script>
    <script>
        let cartItems = [];

        // Load cart items
        async function loadCart() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const emptyCart = document.getElementById('emptyCart');
            const cartContent = document.getElementById('cartContent');

            try {
                loadingState.style.display = 'block';
                errorState.style.display = 'none';

                const response = await fetch('backend/api/get-cart.php');
                if (!response.ok) throw new Error('Failed to load cart');
                
                cartItems = await response.json();
                
                loadingState.style.display = 'none';

                if (cartItems.length === 0) {
                    emptyCart.style.display = 'block';
                    cartContent.style.display = 'none';
                } else {
                    emptyCart.style.display = 'none';
                    cartContent.style.display = 'grid';
                    renderCart();
                }
            } catch (error) {
                loadingState.style.display = 'none';
                errorState.style.display = 'block';
                document.getElementById('errorText').textContent = 'Error: ' + error.message;
            }
        }

        // Render cart items
        function renderCart() {
            const tbody = document.getElementById('cartItemsBody');
            const itemCount = document.getElementById('cartItemCount');
            
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            itemCount.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;

            tbody.innerHTML = cartItems.map(item => `
                <tr>
                    <td>
                        <div class="cart-item-info">
                            <img src="${item.image_url}" alt="${item.name}">
                            <div>
                                <h4>${item.name}</h4>
                                <p>${item.category}</p>
                            </div>
                        </div>
                    </td>
                    <td>$${parseFloat(item.price).toFixed(2)}</td>
                    <td>
                        <div class="quantity-controls">
                            <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        </div>
                    </td>
                    <td>$${(parseFloat(item.price) * item.quantity).toFixed(2)}</td>
                    <td>
                        <button class="btn-remove" onclick="removeItem(${item.id})">Remove</button>
                    </td>
                </tr>
            `).join('');

            updateTotals();
        }

        // Update totals
        function updateTotals() {
            const subtotal = cartItems.reduce((sum, item) => 
                sum + (parseFloat(item.price) * item.quantity), 0
            );
            const deliveryFee = 5.00;
            const total = subtotal + deliveryFee;

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        // Update quantity
        async function updateQuantity(cartId, newQuantity) {
            if (newQuantity < 1) return;

            try {
                const response = await fetch('backend/api/update-cart.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cart_id: cartId, quantity: newQuantity })
                });

                if (response.ok) {
                    loadCart();
                } else {
                    alert('Failed to update quantity');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Remove item
        async function removeItem(cartId) {
            if (!confirm('Remove this item from cart?')) return;

            try {
                const response = await fetch('backend/api/remove-from-cart.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cart_id: cartId })
                });

                if (response.ok) {
                    loadCart();
                } else {
                    const result = await response.json();
                    alert('Failed to remove item: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Validate name
        function validateName(name) {
            if (!name || name.trim().length < 2) {
                return "Name must be at least 2 characters";
            }
            return null; // Valid
        }

        // Validate email
        function validateEmail(email) {
            if (!email || email.trim() === '') {
                return "Email is required";
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return "Please enter a valid email address";
            }
            return null; // Valid
        }

        // Validate phone number (exactly 8 digits)
        function validatePhone(phone) {
            if (!phone || phone.trim() === '') {
                return "Phone number is required";
            }
            
            // Remove all non-digit characters
            const cleanPhone = phone.replace(/\D/g, '');
            
            // Check if exactly 8 digits
            if (!/^\d{8}$/.test(cleanPhone)) {
                return "Phone number must be exactly 8 digits (e.g., 67489380)";
            }
            
            return null; // Valid
        }

        // Validate address (minimum 10 characters)
        function validateAddress(addr) {
            if (!addr || addr.trim().length < 10) {
                return "Address must be at least 10 characters";
            }
            return null; // Valid
        }

        // Handle checkout
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const customerName = document.getElementById('customerName').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;

            // Validate all fields
            const nameError = validateName(customerName);
            if (nameError) {
                alert(nameError);
                document.getElementById('customerName').focus();
                return;
            }

            const emailError = validateEmail(customerEmail);
            if (emailError) {
                alert(emailError);
                document.getElementById('customerEmail').focus();
                return;
            }

            const phoneError = validatePhone(customerPhone);
            if (phoneError) {
                alert(phoneError);
                document.getElementById('customerPhone').focus();
                return;
            }

            const addressError = validateAddress(deliveryAddress);
            if (addressError) {
                alert(addressError);
                document.getElementById('deliveryAddress').focus();
                return;
            }

            const formData = {
                customer_name: customerName.trim(),
                customer_email: customerEmail.trim(),
                customer_phone: customerPhone.trim(),
                delivery_address: deliveryAddress.trim(),
                items: cartItems.map(item => ({
                    menu_item_id: item.menu_item_id,
                    quantity: item.quantity,
                    price: item.price
                }))
            };

            const placeOrderBtn = document.getElementById('placeOrderBtn');
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Processing...';

            try {
                const response = await fetch('backend/api/place-order.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('Order placed successfully!');
                    window.location.href = 'order-confirmation.html?order_id=' + result.order_id;
                } else {
                    alert('Failed to place order: ' + result.error);
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'Place Order';
                }
            } catch (error) {
                alert('Error: ' + error.message);
                placeOrderBtn.disabled = false;
                placeOrderBtn.textContent = 'Place Order';
            }
        });

        // Pre-fill user info if logged in
        const user = sessionStorage.getItem('user');
        if (user) {
            const userData = JSON.parse(user);
            document.getElementById('customerName').value = userData.username || '';
            document.getElementById('customerEmail').value = userData.email || '';
        }

        // Load cart on page load
        loadCart();
    </script>
</body>
</html>
